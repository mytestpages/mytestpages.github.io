{"version":3,"sources":["./src/app/services/order.service.ts"],"names":[],"mappings":"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","file":"common.js","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { AngularFirestore, AngularFirestoreCollection } from '@angular/fire/firestore';\r\nimport { Order } from '../models/order';\r\n\r\nimport firebase from 'firebase/app'\r\nimport { Observable } from 'rxjs';\r\nimport { map, switchMap } from 'rxjs/operators';\r\nimport { User } from '../models/user';\r\nimport { AlertService } from './alert.service';\r\nimport { Router } from '@angular/router';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OrderService {\r\n\r\n  orderCollectionRef: AngularFirestoreCollection<Order>;\r\n  orders: Observable<Order[]>;\r\n\r\n  constructor(private afs:AngularFirestore,  private alert:AlertService, private router: Router) {\r\n    this.orderCollectionRef = this.afs.collection('orders', orders => orders.orderBy('order.date', \"desc\"));\r\n    this.orders = this.orderCollectionRef.snapshotChanges().pipe(\r\n      map(data => data.map(a=>{\r\n        const data =  a.payload.doc.data() as Order;\r\n        const id = a.payload.doc.id;\r\n        return {id, ...data}\r\n      })\r\n    ))\r\n  }\r\n\r\n  getAllOrdersId() {\r\n    return this.orders\r\n  }\r\n\r\n  placeOrder(order:Order){\r\n    this.afs.collection('orders').add({\r\n      order\r\n    }).then(response=>{\r\n      this.afs.collection('users').doc(order.user.uid).update({\r\n        orders: firebase.firestore.FieldValue.arrayUnion(response.id)\r\n      })\r\n    }).then(()=>{\r\n      this.router.navigate(['/user/my-orders'])\r\n      this.alert.success(\"Заказ оформлен\")\r\n    })\r\n  }\r\n\r\n  getUserOrdersList(userId: string):Observable<User>{\r\n    const userDoc = this.afs.doc(`users/${userId}`);\r\n    const userData$ = userDoc.snapshotChanges().pipe(\r\n      map(data => {\r\n        return data.payload.data() as User\r\n      }),\r\n    );\r\n    return userData$;\r\n  }\r\n\r\n  getOrderById(id):Observable<Order> {\r\n    const orderDoc = this.afs.doc(`orders/${id}`);\r\n    const orderData$ = orderDoc.snapshotChanges().pipe(\r\n      map(data => {\r\n        return data.payload.data() as any\r\n      }),\r\n    );\r\n    return orderData$;\r\n  }\r\n\r\n  changeOrderStatus(orderId, newStatus){\r\n    this.afs.collection('orders').doc(orderId).update({\r\n    \"order.status\" :newStatus\r\n    }).then(()=>{\r\n      this.alert.changeStatusInfo(orderId, newStatus)\r\n    })\r\n  }\r\n\r\n  getOrdersByStatus(stat) {\r\n    const collectionRef = this.afs.collection(\"orders\", orders=> orders.where('order.status', '==', stat).orderBy('order.date', 'desc'))\r\n    const resultDocuments$ = collectionRef.snapshotChanges().pipe(\r\n      map(data=>data.map(a=>{\r\n        const id = a.payload.doc.id;\r\n        return{...a.payload.doc.data() as Order, id}\r\n      }))\r\n    )\r\n    return resultDocuments$\r\n  }\r\n\r\n  docChanges(id):any{\r\n    return this.afs.doc(`orders/${id}`).snapshotChanges().pipe(\r\n      map(doc=>{\r\n        const data = doc.payload.data() as Order;\r\n        const id = doc.payload.id;\r\n        return {...data, id}\r\n      })\r\n    )\r\n  }\r\n}"],"sourceRoot":"webpack:///"}